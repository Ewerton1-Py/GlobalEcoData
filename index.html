<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Contributions</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-boxplot@2.1.0"></script> <!-- For boxplot support -->

    <style>
        body { font-family: Arial, sans-serif; }
        .container { display: flex; justify-content: space-between; align-items: flex-start; }
        .form-container { width: 50%; padding-right: 20px; }
        #map { height: 500px; width: 50%; }
        .submit-button, .google-form-button {
            background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px;
            cursor: pointer; text-align: center; margin-top: 10px;
        }
        .error { color: red; font-size: 0.9em; margin-top: 5px; }
        #chartContainer, #histogramContainer, #boxplotContainer { width: 100%; height: 400px; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Submit Your Research</h1>
    <p>Welcome to our research data repository. This platform aims to advance knowledge on environmental contaminants through collective contributions. Suggestions for further improvement are highly appreciated.</p>
    <h2>How to Use This Platform</h2>
    <p>Welcome! To explore data, please select from the filters provided and click "Load Approved Entries." You can filter by analyte, environment, year range, continent, and more. Only approved entries will display on the map and in the charts.</p>
    <p>If youâ€™d like to contribute, use the "Submit New Research Data" button. Your submission will be reviewed and approved by our team before it appears publicly on the platform.</p>
    <div class="container">
        <div class="form-container">
            <label for="analyte">Select Analyte:</label>
            <select id="analyte">
                <option value="">All</option>
                <option value="PAHs">PAHs</option>
                <option value="Alkanes">Alkanes</option>
                <option value="Sterols">Sterols</option>
                <option value="Pesticides">Pesticides</option>
                <option value="VOCs">VOCs</option>
                <option value="PCBs">PCBs</option>
                <option value="Microplastics">Microplastics</option>
                <option value="PFAs">PFAs</option>
                <option value="Synthetic Polymers">Synthetic Polymers</option>
                <option value="Heavy Metals">Heavy Metals</option>
            </select>
            <span id="analyteError" class="error"></span>

            <label for="environment">Select Environment:</label>
            <select id="environment">
                <option value="">All</option>
                <option value="Air and Atmospheric Deposition">Air and Atmospheric Deposition</option>
                <option value="Surface Water">Surface Water</option>
                <option value="Wastewater and Effluents">Wastewater and Effluents</option>
                <option value="Biota">Biota</option>
                <option value="Groundwater">Groundwater</option>
                <option value="Suspended Particulate Matter">Suspended Particulate Matter</option>
                <option value="Sediment">Sediment</option>
                <option value="Soil">Soil</option>
                <option value="Ice and Snow">Ice and Snow</option>
            </select>
            <span id="environmentError" class="error"></span>

            <label for="yearStart">Start Year:</label>
            <input type="text" id="yearStart" placeholder="e.g., 2000">
            <span id="yearStartError" class="error"></span>

            <label for="yearEnd">End Year:</label>
            <input type="text" id="yearEnd" placeholder="e.g., 2022">
            <span id="yearEndError" class="error"></span>

            <label for="zone">Select Zone:</label>
            <select id="zone">
                <option value="">All</option>
                <option value="Frigid Zone">Frigid Zone</option>
                <option value="Temperate Zone">Temperate Zone</option>
                <option value="Tropics">Tropics</option>
            </select>
            <span id="zoneError" class="error"></span>

            <label for="continent">Select Continent:</label>
            <select id="continent">
                <option value="">All</option>
                <option value="Africa">Africa</option>
                <option value="Asia">Asia</option>
                <option value="Europe">Europe</option>
                <option value="North America">North America</option>
                <option value="Oceania">Oceania</option>
                <option value="South America">South America</option>
                <option value="Antarctica">Antarctica</option>
            </select>
            <span id="continentError" class="error"></span>

            <label for="heatmapToggle">Show Heatmap</label>
            <input type="checkbox" id="heatmapToggle">
            <button id="loadEntries" class="submit-button">Load Approved Entries</button>
            <button onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSegI3XJK7z3rwhdezy1sz3P8It2OQSDL_x0f12BUMxDH8CkKg/viewform?usp=sharing', '_blank')" class="google-form-button">
                Submit New Research Data
            </button>
        </div>
        <div id="map"></div>
    </div>

    <div id="histogramContainer">
        <canvas id="concentrationHistogram"></canvas>
    </div>
    <div id="boxplotContainer">
        <canvas id="concentrationBoxplot"></canvas>
    </div>

    <script>
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbyZKigN6pFCSAjj5js1p-zJW3P0FPlbHu8T-FfupmyeOaTLBDe1LC7obrrDyiYkylD9BA/exec';

        // Sanitization Function
        function sanitizeInput(input) {
            if (!input) return '';
            return input.replace(/[&<>"'\/]/g, function (match) {
                const escapes = {
                    "&": "&amp;",
                    "<": "&lt;",
                    ">": "&gt;",
                    '"': "&quot;",
                    "'": "&#x27;",
                    "/": "&#x2F;"
                };
                return escapes[match];
            });
        }

        // Input Validation
        function validateAndSanitizeInput() {
            const yearStart = document.getElementById('yearStart').value;
            const yearEnd = document.getElementById('yearEnd').value;

            let isValid = true;

            // Clear previous errors
            document.getElementById('yearStartError').textContent = '';
            document.getElementById('yearEndError').textContent = '';

            // Validate Year Inputs
            if (yearStart && (isNaN(yearStart) || yearStart < 1900 || yearStart > new Date().getFullYear())) {
                document.getElementById('yearStartError').textContent = 'Invalid start year!';
                isValid = false;
            }
            if (yearEnd && (isNaN(yearEnd) || yearEnd < 1900 || yearEnd > new Date().getFullYear())) {
                document.getElementById('yearEndError').textContent = 'Invalid end year!';
                isValid = false;
            }

            return isValid;
        }

        // Example: Event Listener for Data Load
        document.getElementById('loadEntries').addEventListener('click', async () => {
            if (!validateAndSanitizeInput()) return;

            try {
                const response = await fetch(SHEET_API_URL);
                const data = await response.json();
                console.log('Data loaded:', data); // Debugging
            } catch (err) {
                console.error('Error loading data:', err);
            }
        });
    </script>
</body>
</html>
