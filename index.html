<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Contributions</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-boxplot@2.1.0"></script> <!-- For boxplot support -->

    <style>
        body { font-family: Arial, sans-serif; }
        .container { display: flex; justify-content: space-between; align-items: flex-start; }
        .form-container { width: 50%; padding-right: 20px; }
        #map { height: 500px; width: 50%; }
        .submit-button, .google-form-button {
            background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px;
            cursor: pointer; text-align: center; margin-top: 10px;
        }
        #chartContainer, #histogramContainer, #boxplotContainer { width: 100%; height: 400px; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Submit Your Research</h1>
    <p>Welcome to our research data repository. This platform aims to advance knowledge on environmental contaminants through collective contributions. Suggestions for further improvement are highly appreciated.</p>
    <h2>How to Use This Platform</h2>
    <p>Welcome! To explore data, please select from the filters provided and click "Load Approved Entries." You can filter by analyte, environment, year range, continent, and more. Only approved entries will display on the map and in the charts.</p>
    <p>If you’d like to contribute, use the "Submit New Research Data" button. Your submission will be reviewed and approved by our team before it appears publicly on the platform.</p>
    <div class="container">
        <div class="form-container">
            <p>Select filters, then click to load data:</p>
            <label for="analyte">Select Analyte:</label>
            <select id="analyte">
                <option value="">All</option>
                <option value="PAHs">PAHs</option>
                <option value="Alkanes">Alkanes</option>
                <option value="Sterols">Sterols</option>
                <option value="Pesticides">Pesticides</option>
                <option value="VOCs">VOCs</option>
                <option value="PCBs">PCBs</option>
                <option value="Microplastics">Microplastics</option>
                <option value="PFAs">PFAs</option>
                <option value="Synthetic Polymers">Synthetic Polymers</option>
                <option value="Heavy Metals">Heavy Metals</option>
            </select>
            <label for="environment">Select Environment:</label>
            <select id="environment">
                <option value="">All</option>
                <option value="Air and Atmospheric Deposition">Air and Atmospheric Deposition</option>
                <option value="Surface Water">Surface Water</option>
                <option value="Wastewater and Effluents">Wastewater and Effluents</option>
                <option value="Biota">Biota</option>
                <option value="Groundwater">Groundwater</option>
                <option value="Suspended Particulate Matter">Suspended Particulate Matter</option>
                <option value="Sediment">Sediment</option>
                <option value="Soil">Soil</option>
                <option value="Ice and Snow">Ice and Snow</option>
            </select>
            <label for="yearStart">Start Year:</label>
            <input type="text" id="yearStart" placeholder="e.g., 2000">
            <label for="yearEnd">End Year:</label>
            <input type="text" id="yearEnd" placeholder="e.g., 2022">
            <label for="zone">Select Zone:</label>
            <select id="zone">
                <option value="">All</option>
                <option value="Frigid Zone">Frigid Zone</option>
                <option value="Temperate Zone">Temperate Zone</option>
                <option value="Tropics">Tropics</option>
            </select>
            <label for="continent">Select Continent:</label>
            <select id="continent">
                <option value="">All</option>
                <option value="Africa">Africa</option>
                <option value="Asia">Asia</option>
                <option value="Europe">Europe</option>
                <option value="North America">North America</option>
                <option value="Oceania">Oceania</option>
                <option value="South America">South America</option>
                <option value="Antarctica">Antarctica</option>
            </select>
            <label for="heatmapToggle">Show Heatmap</label>
            <input type="checkbox" id="heatmapToggle">
            <button id="loadEntries" class="submit-button">Load Approved Entries</button>
            <button onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSegI3XJK7z3rwhdezy1sz3P8It2OQSDL_x0f12BUMxDH8CkKg/viewform?usp=sharing', '_blank')" class="google-form-button">
                Submit New Research Data
            </button>
        </div>
        <div id="map"></div>
    </div>

    <div id="histogramContainer">
        <canvas id="concentrationHistogram"></canvas>
    </div>
    <div id="boxplotContainer">
        <canvas id="concentrationBoxplot"></canvas>
    </div>

    <script>
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbyZKigN6pFCSAjj5js1p-zJW3P0FPlbHu8T-FfupmyeOaTLBDe1LC7obrrDyiYkylD9BA/exec';

        const map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        let markerGroup = L.featureGroup().addTo(map);
        let histogramChart, boxplotChart, heatmapLayer;
        let filteredData; // Define filteredData globally

        document.getElementById('heatmapToggle').addEventListener('change', toggleHeatmap);
        document.getElementById('loadEntries').addEventListener('click', loadData);

        async function loadData() {
            try {
                const response = await fetch(SHEET_API_URL);
                const data = await response.json();
                const newData = data.map(row => ({
                    coords: [parseFloat(row.Latitude), parseFloat(row.Longitude)],
                    title: row.PaperTitle,
                    analyte: row.Analyte,
                    environment: row.Environment,
                    Concentration: parseFloat(row.Concentration),
                    Year: parseInt(row.Year),
                    Continent: row.Continent,
                    Link: row.Link,
                    Continent: determineZone(parseFloat(row.Latitude))
                }));
                filterAndDisplayData(newData);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function determineZone(lat) {
            if (lat >= 66.5 || lat <= -66.5) return 'Frigid Zone';
            else if ((lat >= 23.5 && lat < 66.5) || (lat <= -23.5 && lat > -66.5)) return 'Temperate Zone';
            else return 'Tropics';
        }

        function filterAndDisplayData(data) {
            const selectedAnalyte = document.getElementById('analyte').value;
            const selectedEnvironment = document.getElementById('environment').value;
            const yearStart = parseInt(document.getElementById('yearStart').value);
            const yearEnd = parseInt(document.getElementById('yearEnd').value);
            const selectedZone = document.getElementById('zone').value;
            const selectedContinent = document.getElementById('continent').value;

            filteredData = data.filter(entry => {
                return (!selectedAnalyte || entry.analyte === selectedAnalyte) &&
                       (!selectedEnvironment || entry.environment === selectedEnvironment) &&
                       (!isNaN(yearStart) ? entry.year >= yearStart : true) &&
                       (!isNaN(yearEnd) ? entry.year <= yearEnd : true) &&
                       (!selectedZone || entry.zone === selectedZone) &&
                       (!selectedContinent || entry.continent === selectedContinent);
            });

            clearMarkers();
            addMarkers(filteredData);
            plotHistogram(filteredData);
            plotBoxplot(filteredData);
            if (document.getElementById('heatmapToggle').checked) updateHeatmap(filteredData);
        }

        function clearMarkers() {
            markerGroup.clearLayers();
        }

        function addMarkers(entries) {
            entries.forEach(entry => {
                const marker = L.marker(entry.coords)
                    .bindPopup(`<b>${entry.title}</b><br>Analyte: ${entry.analyte}<br>Environment: ${entry.environment}<br>Concentration: ${entry.concentration} µg/g<br>Year: ${entry.year}`);
                markerGroup.addLayer(marker);
            });
            if (entries.length > 0) map.fitBounds(markerGroup.getBounds());
        }

        function updateHeatmap(data) {
            const heatmapData = data.map(entry => [entry.coords[0], entry.coords[1], entry.concentration]);
            if (heatmapLayer) map.removeLayer(heatmapLayer);
            heatmapLayer = L.heatLayer(heatmapData, { radius: 25, blur: 15, maxZoom: 5 }).addTo(map);
        }

        function toggleHeatmap() {
            if (filteredData && document.getElementById('heatmapToggle').checked) {
                updateHeatmap(filteredData);
            } else if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
            }
        }

        function plotHistogram(data) {
            const concentrationByYear = data.reduce((acc, entry) => {
                acc[entry.year] = (acc[entry.year] || 0) + entry.concentration;
                return acc;
            }, {});
            const years = Object.keys(concentrationByYear);
            const totalConcentrations = Object.values(concentrationByYear);

            if (histogramChart) histogramChart.destroy();
            const ctx = document.getElementById('concentrationHistogram').getContext('2d');
            histogramChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Total Concentration (µg/g or µg/L)',
                        data: totalConcentrations,
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { x: { title: { display: true, text: 'Year' } }, y: { beginAtZero: true, title: { display: true, text: 'Total Concentration (µg/g or µg/L)' } } },
                    plugins: { title: { display: true, text: `Total Yearly Concentration of ${data[0]?.analyte || 'Selected Analyte'}` } }
                }
            });
        }

        function plotBoxplot(data) {
            const environmentGroups = data.reduce((acc, entry) => {
                acc[entry.environment] = acc[entry.environment] || [];
                acc[entry.environment].push(entry.concentration);
                return acc;
            }, {});
            const environments = Object.keys(environmentGroups);
            const boxplotData = environments.map(env => environmentGroups[env]);

            if (boxplotChart) boxplotChart.destroy();
            const ctx = document.getElementById('concentrationBoxplot').getContext('2d');
            boxplotChart = new Chart(ctx, {
                type: 'boxplot',
                data: {
                    labels: environments,
                    datasets: [{
                        label: 'Concentration by Environment',
                        data: boxplotData,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Concentration (µg/g or µg/L)' } } },
                    plugins: { title: { display: true, text: 'Concentration Distribution by Environment' } }
                }
            });
           }
    </script>
</body>
</html>
